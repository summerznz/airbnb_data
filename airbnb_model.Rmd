---
title: "airbnb_model"
author: "Ningze Zu"
date: "11/25/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,out.width="0.9\\linewidth",dev="png",fig.align  = 'center')
pacman::p_load(ggplot2,knitr,arm,data.table,foreign,gridExtra,car,stringr,rstan,rstanarm,zoo)
library(tidyverse)
library(leaflet)
library(RColorBrewer)
library(corrplot)
library(ggcorrplot)
library(lattice)
library(plotly)
air <- read.csv("air.csv")
airbnb_se <- air %>% dplyr::filter(state == "WA")
airbnb_se$Area <- rep("Seattle",nrow(airbnb_se))

sea <- read.csv("sea.csv")
se <- sea %>% dplyr::filter(state == "WA")
nei <- data.frame(se$neighbourhood_group_cleansed)
airbnb_se <- cbind(airbnb_se,nei)
neighbourhood <- airbnb_se$se.neighbourhood_group_cleansed
```
##1. Abstract 

In this project, I will perform an exploratory data analysis to select features and build a model to predict the Airbnb listing prices in Seattle and compare with the prices of Hotels in Seattle.  

##2. Introduction

####2.1 Background

Airbnb is a well-known website, providing online hospitality service and enabling hosts to list their properties and visitors to rent short-term accommodations.

####2.2 Previous work (Exploratory Data Analysis)
##### a. Price Distribution

First, I looked into the price distribution among each of the cities. Then, I decided to choose price range betweem 0 and 1000 USD since the data contains outliers when the price is over 1000 USD. After excluding the price over 1000 USD, the price distributions are shown as following chart: 
```{r  echo=FALSE}
##price distribution in all five cities
##0~1000
airbnb_se_1 <- airbnb_se %>% filter(price > 0 & price <= 1000)
ggplot(airbnb_se_1, aes(price, fill = room_type)) + 
  geom_histogram(binwidth = 10) + theme_light() +   
  scale_fill_brewer(palette = "RdPu") + 
  scale_x_continuous(name ="Price ($)", breaks = seq(0, 1000, by = 200)) + 
  scale_y_continuous(name="Frequency of Price ")+ 
  ggtitle("Price Distribution($0 ~$1000)") + 
  theme(axis.title.x = element_text(face="bold",  size=12), 
        axis.title.y = element_text(face="bold",  size=12),
        plot.title = element_text(size=14, face="bold"),  
        axis.text.x  = element_text(vjust=0.5, size=10)) +
  theme(plot.title = element_text(hjust = 0.5)) 
```
The plots show a high concentration of listing prices between 0 and 100 USD. 

##### b. Variables

Number of bedrooms will always be a major factor to price of Airbnb. I made a barplot to show the average prices over different number of bedroom. In this case, we can see that there is a certain relationship between the average price of Airbnb listings and number of bedrooms. 
```{r  echo=FALSE}
##bedroom ~ price 
airbnb_se_bed <- airbnb_se %>% filter(price > 0 & price <= 1000) %>% 
  filter(bedrooms < 15)
bedroom_se <- airbnb_se_bed %>% dplyr::select(price, bedrooms)
bedroom_se <- bedroom_se %>% group_by(bedrooms) %>% summarise(mean_price = mean(price))
#barplot
ggplot(bedroom_se, aes(y=mean_price, x=bedrooms,fill=as.factor(bedrooms))) + 
      geom_bar(stat="identity", fill="pink") +
      scale_x_continuous(name ="Number of Bedrooms", breaks = seq(0, 50, by = 5)) +   
      scale_y_continuous(name = "Mean price", breaks = seq(0, 1000, by = 200)) + theme_bw() + 
      ggtitle("Price over different number of bedrooms") +
      theme(axis.title.x = element_text(face="bold",  size=12), 
            axis.title.y = element_text(face="bold",  size=12),
            plot.title = element_text(size=14, face="bold")) +
      theme(plot.title = element_text(hjust = 0.5))
```

Next, I did several scatterplot to show the price versus different variables such as 'bedrooms', 'bathrooms', 'accommodates'. In case it is hard to see if there is relationship between price and each of these vairables , so I add a line to see the trend of the points. From these plots, we can also see that number of bedrooms, number of bathrooms and accommodates have a certain effect on the price of Airbnb listings. 
```{r  echo=FALSE}
airbnb_se_1 <- airbnb_se %>% filter(price > 0 & price <= 1000) %>% 
  filter(bedrooms < 15) %>% filter(bathrooms < 15) %>% filter(accommodates < 20)
ggplot(airbnb_se_1, aes(x=bedrooms, y=price)) + geom_point(color="pink") + 
      geom_smooth(method = "lm", color="green") + theme_bw() + 
      ggtitle("Price over number of bedrooms")+  
      theme(axis.title.x = element_text(face="bold",  size=12), 
            axis.title.y = element_text(face="bold",  size=12),
            plot.title = element_text(size=14, face="bold")) +
      theme(plot.title = element_text(hjust = 0.5))
ggplot(airbnb_se_1, aes(x=bathrooms, y=price)) + geom_point(color="pink") + 
      geom_smooth(method = "lm", color="green") + theme_bw() + 
      ggtitle("Price over number of bathrooms")+  
      theme(axis.title.x = element_text(face="bold",  size=12), 
            axis.title.y = element_text(face="bold",  size=12),
            plot.title = element_text(size=14, face="bold")) +
      theme(plot.title = element_text(hjust = 0.5))
ggplot(airbnb_se_1, aes(x=accommodates, y=price)) + geom_point(color="pink") + 
      geom_smooth(method = "lm", color="green") + theme_bw() + 
      ggtitle("Price over number of accommodates")+  
      theme(axis.title.x = element_text(face="bold",  size=12), 
            axis.title.y = element_text(face="bold",  size=12),
            plot.title = element_text(size=14, face="bold")) +
      theme(plot.title = element_text(hjust = 0.5))
```

The next histogram chart shows the count of different property types in Seattle. We we can observe the disparity in count of different property types. Some property types have more Airbnb listings than others, most of the Airbnb listings' property types are 'Apartment', 'House' and 'Condo'. 
```{r echo=FALSE}
ggplot(airbnb_se_1, aes(x=property_type)) + 
  geom_bar(fill="lightpink1") + theme_light() +   
  scale_x_discrete(name ="Property Type") + 
  ggtitle("Count of Property Types") + 
  theme(axis.title.x = element_text(face="bold",  size=12), 
        axis.title.y = element_text(face="bold",  size=12),
        plot.title = element_text(size=14, face="bold"),  
        axis.text.x  = element_text(angle=90, vjust=0.5, size=10)) +
  theme(plot.title = element_text(hjust = 0.5)) + theme(legend.position="none")
```

In Airbnb listings, there are three types of room: Entire home/apt, Shared room and Private room. Room type is also a major factor of the price. 
```{r echo=FALSE}
airbnb_se_2 <- airbnb_se %>% filter(price > 0 & price <= 1000) %>% dplyr::select(room_type, price)
type_se <- airbnb_se_2  %>% group_by(room_type) %>% 
  summarise(mean_price = mean(price)) %>% arrange(desc(mean_price))
ggplot(type_se, aes(y=mean_price, x=room_type, fill=room_type)) + 
      geom_bar(stat="identity") + scale_fill_brewer(palette = "RdPu") +
      scale_x_discrete(name ="Different Room Type") + 
      scale_y_continuous(name="price($)", breaks = seq(0, 1000, by = 50)) + 
      ggtitle("Price over Different Room type in Seattle") + 
      theme_bw() +
      theme(axis.title.x = element_text(face="bold",  size=12), 
            axis.title.y = element_text(face="bold",  size=12),
            plot.title = element_text(size=14, face="bold"),  
            axis.text.x  = element_text(vjust=0.5, size=10)) +
      theme(plot.title = element_text(hjust = 0.5))
```

Next, the scatterplot shows the prices over review rate score. 
```{r echo=FALSE}
ggplot(airbnb_se_1, aes(x=review_scores_rating, y=price)) + geom_point(color="pink") + 
      theme_bw() +  ggtitle("Price over Rate Scores")+  
      theme(axis.title.x = element_text(face="bold",  size=12), 
            axis.title.y = element_text(face="bold",  size=12),
            plot.title = element_text(size=14, face="bold")) +
      theme(plot.title = element_text(hjust = 0.5))
```

Lastly, The bar plot below shows the average prices in different neighbourhood. To give a better understanding of the price in different neighbourhoods, I plotted a heatmap to show the room price in different neighbourhoods with different room types.
```{r echo=FALSE}
ggplot(airbnb_se_1, aes(x=se.neighbourhood_group_cleansed)) + 
  geom_bar(fill="lightpink1") + theme_light() +   
  scale_x_discrete(name ="Neighbourhood") + 
  ggtitle("Count in Different Neighbourhood") + 
  theme(axis.title.x = element_text(face="bold",  size=12), 
        axis.title.y = element_text(face="bold",  size=12),
        plot.title = element_text(size=14, face="bold"),  
        axis.text.x  = element_text(angle=90, vjust=0.5, size=8)) +
  theme(plot.title = element_text(hjust = 0.5)) + theme(legend.position="none")




airbnb_se_nei <- airbnb_se %>% filter(price > 0 & price <= 1000) %>% dplyr::select(room_type, price,se.neighbourhood_group_cleansed)
nei_se <- airbnb_se_nei %>% group_by(room_type,se.neighbourhood_group_cleansed) %>% 
  summarise(mean_price = mean(price)) %>% arrange(desc(mean_price))



ggplot(data = nei_se, mapping = aes(x = room_type,y =se.neighbourhood_group_cleansed, fill = mean_price)) + 
  geom_tile() + geom_text(aes(label = round(mean_price,0)), size=3)+ scale_fill_gradient(name = "Price",
                      low = "ivory",
                      high = "hotpink")  + xlab(label = "room type") + ylab(label = "neighbourhood") +theme_classic()+ ggtitle("Neighbourhood ~ Room type")+ theme(axis.title.x = element_text(face="bold",  size=12), 
            axis.title.y = element_text(face="bold",  size=12),
            plot.title = element_text(size=14, face="bold")) +
      theme(plot.title = element_text(hjust = 0.5))
```

```{r}
###leaflet
```



##3. Method

####3.1 Datasource 

Data source: http://insideairbnb.com/get-the-data.html

Inside Airbnb Project is an independent and non-commercial set of tools that
enables people to explore how Airbnb is really being used in cities around the
world.

Features of dataset: room_id, property_type, room_type, city, neighbourhood,
accommodates, review_score_rating, bedrooms, bathrooms, numbers_of_reviews, latitude,
longitude.

####3.2 Model used

First, I fit a classic linear regression model without group variabls and draw a binned residual plot. 
```{r echo=FALSE}
## First non-multilevel model withoud group variables
airbnb_se_m <- airbnb_se %>% filter(price > 0 & price <= 1000) 
lm1 <- lm(price ~ bedrooms + bathrooms + accommodates + review_scores_rating 
          + number_of_reviews, data = airbnb_se_m)
summary(lm1)
plot(predict(lm1), residuals(lm1), main = "Residual plot", xlab = "Expected Value", ylab = "Residual")
binnedplot(predict(lm1), residuals(lm1))

### group: neighbourhood
p1 <- ggplot(airbnb_se_m)+
  geom_point(aes(x=bedrooms,y=price,color=factor(se.neighbourhood_group_cleansed)),alpha=0.3)+
  stat_smooth(aes(x=bedrooms,y=price),se=FALSE,method = "lm") + theme_bw() +
  theme(legend.position="none") + ggtitle("Price ~ Bedroom (Group: neighbourhood)")

### group: Property type
p2 <- ggplot(airbnb_se_m)+
  geom_point(aes(x=bedrooms,y=price,color=factor(property_type)),alpha=0.3)+
  stat_smooth(aes(x=bedrooms,y=price),se=FALSE,method = "lm") + theme_bw() +
  theme(legend.position="none") + ggtitle("Price ~ Bedroom (Group: property type)")

### Classic Linear Regression Model within Areas
p3 <- ggplot(airbnb_se_m)+geom_point()+aes(x=bedrooms,y=price)+
  facet_wrap(~se.neighbourhood_group_cleansed)+geom_smooth(method="lm",se=TRUE)+ theme_bw()+
  xlab("Numbers of Bedrooms")+ ylab("Price ($)")+ 
  ggtitle("Price ~ Bedroom (Group: Neighbourhood)")

### Classic Linear Regression Model within Property type  
p4<- ggplot(airbnb_se_m)+geom_point()+aes(x=bedrooms,y=price)+
  facet_wrap(~property_type)+geom_smooth(method="lm",se=TRUE) + theme_bw()+
  xlab("Numbers of Bedrooms")+ ylab("Price ($)") + 
  ggtitle("Price ~ Bedroom (Group: Property type)")

grid.arrange(p1,p3, nrow=1)
grid.arrange(p2,p4, nrow=1)

```

Next, I adjusted model by adding group variable 'neighbourhood' and 'property type' and draw the binned residual plot. Most variables seemed significant: bedrooms, bathrooms, accommodates, review_scores_rating, room_type, numbers_of_reviews. R-square is over 0.5 and p-value is pretty small. 
```{r echo=FALSE}
## adjusted model with group variable “Area” 
lm2 <- lm(price ~ bedrooms + bathrooms + accommodates + review_scores_rating + 
          se.neighbourhood_group_cleansed + room_type + number_of_reviews, data = airbnb_se_m)
summary(lm2)
plot(predict(lm2), residuals(lm2), main = "Residual plot", xlab = "Expected Value", ylab = "Residual")
binnedplot(predict(lm2), residuals(lm2))
```



##4. Result 

####4.1 Model choice 

####4.2 Interpretaions

####4.3 Model checking 

##5. Discussion 

####5.1 Implications

####5.2 Limitation

####5.3 Future direction

##6. Acknowledgement 

##7. Reference 

##8. Appendix
